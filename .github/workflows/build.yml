name: Build Kernel (Bazel)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup JDK 17 (required by Bazel)
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Install Bazelisk
        run: |
          sudo curl -L https://github.com/bazelbuild/bazelisk/releases/download/v1.19.0/bazelisk-linux-amd64 -o /usr/local/bin/bazel
          sudo chmod +x /usr/local/bin/bazel

      - name: Ensure BUILD.bazel for kleaf exists
        run: |
          mkdir -p build/kernel/kleaf
          if [ ! -f build/kernel/kleaf/BUILD.bazel ]; then
            echo '# Auto-generated BUILD.bazel for Bazel package recognition' > build/kernel/kleaf/BUILD.bazel
            echo 'exports_files(["common_kernels.bzl"])' >> build/kernel/kleaf/BUILD.bazel
          fi

      - name: Run Bazel Build
        run: |
          echo "=== Starting kernel build ==="
          bazel build //:peridot_dist || bazel build //:allmods_peridot
          ls -lh bazel-bin || true

      - name: Upload boot.img artifact
        uses: actions/upload-artifact@v3
        with:
          name: boot-image
          path: |
            bazel-bin/**/*.img
            bazel-bin/**/boot.img
          if-no-files-found: warn
